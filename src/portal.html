<script>
  const API_URL = '/api/fetch'; // Replace with your real API endpoint
  const DELETE_URL = '/api/delete'; // Replace with your delete API endpoint
  let fetchedData = []; // To store the fetched data globally for searching

  // Function to render cards dynamically
  const renderCards = (data) => {
    const container = document.getElementById('cardContainer');
    container.innerHTML = ''; // Clear any existing content

    if (data.length === 0) {
      container.innerHTML = `<p>No records found</p>`;
      return;
    }

    data.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        <div class="card-content">
          <span class="card-title">AWB: ${item.awb}</span>
          <p><strong>Datetime:</strong> ${item.datetime}</p>
          <p><strong>Remark:</strong> ${item.remark ? item.remark : 'No remarks'}</p>
        </div>
        <div class="card-action">
          <button class="btn red" onclick="deleteRecord('${item._id}')">Delete</button>
        </div>
      `;

      container.appendChild(card);
    });
  };

  // Fetch data from the API
  const fetchData = async () => {
    try {
      const response = await fetch(API_URL);
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const result = await response.json();

      // Sort data by the latest entry based on `_id`
      fetchedData = result.data.sort((a, b) => b._id.localeCompare(a._id));

      renderCards(fetchedData);
    } catch (error) {
      console.error('Error fetching data:', error);
      const container = document.getElementById('cardContainer');
      container.innerHTML = `<p style="color: red;">Failed to load data. Please try again later.</p>`;
    }
  };

  // Delete record function
  const deleteRecord = async (id) => {
    if (!confirm('Are you sure you want to delete this record?')) return;

    try {
      const response = await fetch(DELETE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      alert('Record deleted successfully.');
      fetchData(); // Reload data after deletion
    } catch (error) {
      console.error('Error deleting record:', error);
      alert('Failed to delete the record. Please try again.');
    }
  };

  // Search functionality
  const handleSearch = (event) => {
    const query = event.target.value.toLowerCase();
    const filteredData = fetchedData.filter(item =>
      item.awb.toLowerCase().includes(query) ||
      item.datetime.toLowerCase().includes(query) ||
      (item.remark && item.remark.toLowerCase().includes(query))
    );

    renderCards(filteredData);
  };

  // Go back to the root
  const goHome = () => {
    window.location.href = '/';
  };

  // Attach event listener to the search input
  document.getElementById('searchInput').addEventListener('input', handleSearch);

  // Load data on page load
  fetchData();
</script>
